// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  TEACHER
  STUDENT
}

enum NoticeCategory {
  EXAM
  EVENT
  HOLIDAY
  GENERAL
}

enum ExamType {
  MIDTERM
  FINAL
  QUIZ
  ASSIGNMENT
  PROJECT
}

enum ExamStatus {
  UPCOMING
  ACTIVE
  COMPLETED
  CANCELLED
}

enum QuestionType {
  MULTIPLE_CHOICE
  FILE_UPLOAD
  SHORT_ANSWER
  LONG_ANSWER
}

enum LiveClassStatus {
  SCHEDULED
  LIVE
  COMPLETED
  CANCELLED
}

enum MaterialType {
  PDF
  DOCX
  PPT
  VIDEO
  LINK
  IMAGE
}

enum ResourceType {
  PDF
  DOCUMENT
  PRESENTATION
  SPREADSHEET
  VIDEO
  AUDIO
  IMAGE
  LINK
  YOUTUBE
  ARCHIVE
  CODE
  OTHER
}

enum ResourceStatus {
  DRAFT
  PUBLISHED
  HIDDEN
  ARCHIVED
}

enum ResourceCategory {
  LECTURE_NOTE
  ASSIGNMENT
  REFERENCE_MATERIAL
  SAMPLE_CODE
  PRACTICE_QUESTION
  SOLUTION
  READING_MATERIAL
  SUPPLEMENTARY
  EXTERNAL_LINK
  OTHER
}

enum NotificationType {
  LIVE_CLASS
  EXAM
  NOTICE
  RESULT
  MATERIAL
  MESSAGE
  GENERAL
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum Grade {
  A_PLUS
  A
  B_PLUS
  B
  C_PLUS
  C
  D
  F
}

enum BatchStatus {
  PLANNING
  ACTIVE
  COMPLETED
  GRADUATED
  ARCHIVED
}

enum LessonType {
  VIDEO
  YOUTUBE_LIVE
  PDF
  TEXT
  QUIZ
  ASSIGNMENT
  EXTERNAL_LINK
}

enum ModuleStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  PUBLISHED
  ARCHIVED
}

enum ActivityType {
  MODULE_ENROLLED
  LESSON_VIEWED
  LESSON_COMPLETED
  QUIZ_ATTEMPTED
  NOTE_CREATED
  LIVE_SESSION_JOINED
  MODULE_COMPLETED
  ASSIGNMENT_SUBMITTED
}

model User {
  id            String    @id @default(cuid())
  name          String
  firstName     String? // Added for better name management
  middleName    String? // Added for full names
  lastName      String? // Added for better name management
  email         String?   @unique // Made optional for students
  phone         String?   @unique
  symbolNo      String?   @unique // Student Symbol Number - now auto-generated
  school        String? // Added for students
  department    String? // Added for teachers
  experience    String? // Added for teachers
  role          Role      @default(STUDENT)
  password      String? // Made optional - will be auto-generated
  profileImage  String?
  verified      Boolean   @default(false)
  isActive      Boolean   @default(true)
  isBlocked     Boolean   @default(false)
  blockReason   String?
  blockedBy     String?
  blockedAt     DateTime?
  lastLogin     DateTime?
  loginAttempts Int       @default(0)
  lockoutUntil  DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  profile               Profile?
  teacherClasses        TeacherClass[]
  studentClasses        StudentClass[]
  liveClassesCreated    LiveClass[]         @relation("TeacherLiveClasses")
  attendances           Attendance[]
  materialsUploaded     Material[]          @relation("TeacherMaterials")
  materialAccessLogs    MaterialAccessLog[]
  noticesPublished      Notice[]            @relation("PublishedByUser")
  examsCreated          Exam[]              @relation("ExamCreatedBy")
  examSubmissions       ExamSubmission[]
  results               Result[]
  certificatesReceived  Certificate[]
  notificationsSent     Notification[]      @relation("NotificationSender")
  notificationsReceived Notification[]      @relation("NotificationReceiver")
  messagesSent          Message[]           @relation("MessageSender")
  messagesReceived      Message[]           @relation("MessageReceiver")
  routinesCreated       Routine[]           @relation("RoutineCreatedBy")
  teacherRoutines       Routine[]           @relation("TeacherRoutines")
  adminSessions         AdminSession[]

  // Module system relations
  modulesCreated       Module[]           @relation("ModuleTeacher")
  modulesApproved      Module[]           @relation("ModuleApprover")
  modulesRejected      Module[]           @relation("ModuleRejecter")
  enrollmentsAsStudent ModuleEnrollment[] @relation("StudentEnrollments")
  enrollmentsCreated   ModuleEnrollment[] @relation("EnrollmentCreator")
  topicProgress        TopicProgress[]
  lessonProgress       LessonProgress[]
  lessonNotes          LessonNote[]
  moduleReviews        ModuleReview[]
  activityHistory      ActivityHistory[]

  // Resource system relations
  resourcesUploaded  ModuleResource[]    @relation("ResourceUploader")
  resourceAccessLogs ResourceAccessLog[] @relation("ResourceAccess")

  // Batch and Graduation system relations
  batchId                 String?
  batch                   Batch?            @relation("StudentBatch", fields: [batchId], references: [id])
  batchesCreated          Batch[]           @relation("BatchCreator")
  classEnrollments        ClassEnrollment[] @relation("StudentClassEnrollments")
  classEnrollmentsCreated ClassEnrollment[] @relation("ClassEnrollmentCreator")
  graduations             Graduation[]      @relation("StudentGraduations")
  graduationsCreated      Graduation[]      @relation("GraduationCreator")

  // New unified enrollment system (Option 2 - Hybrid)
  subjectEnrollments        SubjectEnrollment[] @relation("StudentSubjectEnrollments")
  subjectEnrollmentsCreated SubjectEnrollment[] @relation("SubjectEnrollmentCreator")

  // Exam system relations
  questionsCreated   Question[]           @relation("QuestionCreator")
  examAttempts       StudentExamAttempt[] @relation("StudentExamAttempts")
  examAttemptsGraded StudentExamAttempt[] @relation("ExamAttemptsGraded")

  // Notice system relations
  noticeReads             NoticeRead[]            @relation("NoticeReads")
  notificationPreferences NotificationPreference? @relation("UserNotificationPreferences")

  // FCM Device Tokens for push notifications
  deviceTokens DeviceToken[] @relation("UserDeviceTokens")

  // Security audit relations
  auditLogs AuditLog[]

  @@map("users")
}

model AdminSession {
  id           String   @id @default(cuid())
  userId       String
  token        String   @unique
  refreshToken String?  @unique
  ipAddress    String?
  userAgent    String?
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("admin_sessions")
}

model Profile {
  id               String    @id @default(cuid())
  userId           String    @unique
  address          String?
  dateOfBirth      DateTime?
  guardianName     String?
  guardianPhone    String?
  emergencyContact String?
  bloodGroup       String?
  admissionDate    DateTime?
  rollNumber       String?
  classSection     String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("profiles")
}

model Class {
  id          String   @id @default(cuid())
  name        String   @unique // e.g., "Class 10", "Grade 12"
  section     String? // e.g., "A", "B", "Science"
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  teachers         TeacherClass[]
  students         StudentClass[]
  liveClasses      LiveClass[]
  routines         Routine[]
  notices          Notice[]
  exams            Exam[]
  messages         Message[]
  modules          Module[]
  classBatches     ClassBatch[]
  classEnrollments ClassEnrollment[]

  // New unified enrollment system
  subjectEnrollments SubjectEnrollment[] @relation("ClassSubjectEnrollments")

  @@unique([name, section])
  @@map("classes")
}

model Subject {
  id          String   @id @default(cuid())
  name        String   @unique
  code        String?  @unique
  description String?
  color       String? // For UI color coding
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  teachers    TeacherClass[]
  liveClasses LiveClass[]
  materials   Material[]
  routines    Routine[]
  exams       Exam[]
  results     Result[]
  modules     Module[]

  // New unified enrollment system
  subjectEnrollments SubjectEnrollment[] @relation("SubjectEnrollments")

  @@map("subjects")
}

model TeacherClass {
  id        String   @id @default(cuid())
  teacherId String
  classId   String
  subjectId String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  teacher User    @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  class   Class   @relation(fields: [classId], references: [id], onDelete: Cascade)
  subject Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@unique([teacherId, classId, subjectId])
  @@map("teacher_classes")
}

model StudentClass {
  id         String   @id @default(cuid())
  studentId  String
  classId    String
  isActive   Boolean  @default(true)
  enrolledAt DateTime @default(now())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  student User  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  class   Class @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@unique([studentId, classId])
  @@map("student_classes")
}

model LiveClass {
  id           String          @id @default(cuid())
  title        String
  description  String?
  subjectId    String
  teacherId    String
  classId      String
  moduleId     String? // Optional: Link to module for course-specific live classes
  youtubeUrl   String?
  meetingLink  String?
  startTime    DateTime
  endTime      DateTime?
  status       LiveClassStatus @default(SCHEDULED)
  isRecorded   Boolean         @default(false)
  recordingUrl String?
  maxStudents  Int?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  // Relations
  subject     Subject      @relation(fields: [subjectId], references: [id])
  teacher     User         @relation("TeacherLiveClasses", fields: [teacherId], references: [id])
  class       Class        @relation(fields: [classId], references: [id])
  module      Module?      @relation(fields: [moduleId], references: [id], onDelete: SetNull)
  attendances Attendance[]

  @@index([moduleId])
  @@map("live_classes")
}

model Attendance {
  id          String    @id @default(cuid())
  studentId   String
  liveClassId String
  joinedAt    DateTime  @default(now())
  leftAt      DateTime?
  duration    Int? // in minutes
  isPresent   Boolean   @default(true)
  createdAt   DateTime  @default(now())

  // Relations
  student   User      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  liveClass LiveClass @relation(fields: [liveClassId], references: [id], onDelete: Cascade)

  @@unique([studentId, liveClassId])
  @@map("attendances")
}

model Material {
  id            String       @id @default(cuid())
  title         String
  description   String?
  subjectId     String
  type          MaterialType
  fileUrl       String?
  fileName      String?
  fileSize      Int?
  chapter       String?
  teacherId     String
  isPublic      Boolean      @default(true)
  downloadCount Int          @default(0)
  uploadedAt    DateTime     @default(now())
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  // Relations
  subject    Subject             @relation(fields: [subjectId], references: [id])
  teacher    User                @relation("TeacherMaterials", fields: [teacherId], references: [id])
  accessLogs MaterialAccessLog[]

  @@map("materials")
}

model MaterialAccessLog {
  id           String    @id @default(cuid())
  studentId    String
  materialId   String
  viewedAt     DateTime?
  downloadedAt DateTime?
  ipAddress    String?
  createdAt    DateTime  @default(now())

  // Relations
  student  User     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  material Material @relation(fields: [materialId], references: [id], onDelete: Cascade)

  @@map("material_access_logs")
}

model Routine {
  id        String    @id @default(cuid())
  classId   String
  subjectId String
  teacherId String
  dayOfWeek DayOfWeek
  startTime String // Format: "09:00"
  endTime   String // Format: "10:00"
  room      String?
  isActive  Boolean   @default(true)
  createdBy String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  class         Class   @relation(fields: [classId], references: [id])
  subject       Subject @relation(fields: [subjectId], references: [id])
  teacher       User    @relation("TeacherRoutines", fields: [teacherId], references: [id])
  createdByUser User    @relation("RoutineCreatedBy", fields: [createdBy], references: [id])

  @@unique([classId, subjectId, dayOfWeek, startTime])
  @@map("routines")
}

model Notice {
  id            String         @id @default(cuid())
  title         String
  content       String         @db.Text // Support long content
  category      NoticeCategory @default(GENERAL)
  priority      Priority       @default(MEDIUM)
  attachmentUrl String?
  isPinned      Boolean        @default(false) // Pin important notices
  isPublished   Boolean        @default(false)
  isActive      Boolean        @default(true) // Soft delete support
  publishedAt   DateTime?
  expiresAt     DateTime?
  scheduledFor  DateTime? // For scheduling future notices
  actionUrl     String? // Deep link to relevant page
  viewCount     Int            @default(0)

  // Targeting options (null = global/all)
  classId    String? // Target specific class
  batchId    String? // Target specific batch
  moduleId   String? // Target specific module
  targetRole Role? // Target specific role (ADMIN, TEACHER, STUDENT)

  // Creator info
  publishedBy String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  class           Class?       @relation(fields: [classId], references: [id])
  batch           Batch?       @relation(fields: [batchId], references: [id])
  module          Module?      @relation(fields: [moduleId], references: [id])
  publishedByUser User         @relation("PublishedByUser", fields: [publishedBy], references: [id])
  readBy          NoticeRead[] // Track who has read this notice

  @@index([isPublished, isActive, expiresAt])
  @@index([classId, isPublished, isActive])
  @@index([batchId, isPublished, isActive])
  @@index([moduleId, isPublished, isActive])
  @@index([publishedBy])
  @@map("notices")
}

// Track notice reads for notification management
model NoticeRead {
  id             String   @id @default(cuid())
  noticeId       String
  userId         String
  readAt         DateTime @default(now())
  deliveryStatus String   @default("delivered") // delivered, pending, failed

  // Relations
  notice Notice @relation(fields: [noticeId], references: [id], onDelete: Cascade)
  user   User   @relation("NoticeReads", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([noticeId, userId]) // User can only read a notice once
  @@index([userId, readAt])
  @@map("notice_reads")
}

// Notification preferences for users
model NotificationPreference {
  id                   String   @id @default(cuid())
  userId               String   @unique
  emailEnabled         Boolean  @default(true)
  inAppEnabled         Boolean  @default(true)
  pushEnabled          Boolean  @default(true)
  examNotifications    Boolean  @default(true)
  eventNotifications   Boolean  @default(true)
  generalNotifications Boolean  @default(true)
  urgentOnly           Boolean  @default(false)
  quietHoursEnabled    Boolean  @default(false)
  quietHoursStart      String? // Format: "22:00"
  quietHoursEnd        String? // Format: "08:00"
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // Relations
  user User @relation("UserNotificationPreferences", fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_preferences")
}

// ============================================
// COMPREHENSIVE EXAM SYSTEM
// ============================================

model Exam {
  id          String     @id @default(cuid())
  title       String
  description String?    @db.Text // Support long descriptions with Nepali text
  subjectId   String
  classId     String?
  batchId     String? // Optional: Target specific batch
  type        ExamType   @default(QUIZ)
  status      ExamStatus @default(UPCOMING)

  // Scheduling
  startTime DateTime
  endTime   DateTime
  duration  Int? // in minutes - optional, can use endTime - startTime

  // Marks Configuration
  totalMarks   Int?
  passingMarks Int?

  // Instructions and Settings
  instructions           String? @db.Text
  allowLateSubmission    Boolean @default(false)
  shuffleQuestions       Boolean @default(false)
  showResultsImmediately Boolean @default(false)
  allowReview            Boolean @default(true) // Allow students to review after submission
  maxAttempts            Int     @default(1)

  // Legacy external exam support
  examLink   String? // For Google Form or external exam links (backward compatibility)
  isExternal Boolean @default(false)

  // Metadata
  createdBy   String
  publishedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  subject       Subject              @relation(fields: [subjectId], references: [id])
  class         Class?               @relation(fields: [classId], references: [id])
  createdByUser User                 @relation("ExamCreatedBy", fields: [createdBy], references: [id])
  questions     ExamQuestion[]
  attempts      StudentExamAttempt[]
  results       Result[]
  certificates  Certificate[]

  // Legacy submission support (backward compatibility)
  submissions ExamSubmission[]

  @@index([subjectId])
  @@index([classId])
  @@index([status])
  @@index([startTime])
  @@index([createdBy])
  @@map("exams")
}

model Question {
  id               String       @id @default(cuid())
  questionText     String       @db.Text // Supports Nepali Unicode
  questionTextHtml String?      @db.Text // Rich text HTML version
  questionType     QuestionType

  // For file upload type questions
  allowMultipleFiles Boolean @default(true)
  maxFiles           Int     @default(5)
  acceptedFileTypes  String? // comma-separated: "image/jpeg,image/png,application/pdf"
  maxFileSizeMB      Int     @default(10)

  // Marks
  marks         Float  @default(0)
  negativeMarks Float? @default(0)

  // Optional explanation/solution
  explanation     String? @db.Text
  explanationHtml String? @db.Text

  // Question metadata
  difficulty String? // EASY, MEDIUM, HARD
  tags       String[] // Searchable tags

  // Audit
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  createdByUser  User             @relation("QuestionCreator", fields: [createdBy], references: [id])
  options        QuestionOption[]
  examQuestions  ExamQuestion[]
  studentAnswers StudentAnswer[]

  @@index([questionType])
  @@index([createdBy])
  @@map("questions")
}

model QuestionOption {
  id             String   @id @default(cuid())
  questionId     String
  optionText     String   @db.Text // Supports Nepali Unicode
  optionTextHtml String?  @db.Text
  isCorrect      Boolean  @default(false)
  orderIndex     Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  question       Question        @relation(fields: [questionId], references: [id], onDelete: Cascade)
  studentAnswers StudentAnswer[]

  @@index([questionId])
  @@map("question_options")
}

model ExamQuestion {
  id          String   @id @default(cuid())
  examId      String
  questionId  String
  orderIndex  Int      @default(0)
  marks       Float? // Override question marks if needed
  isOptional  Boolean  @default(false)
  sectionName String? // Optional: Group questions into sections
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  exam     Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([examId, questionId])
  @@index([examId])
  @@index([orderIndex])
  @@map("exam_questions")
}

model StudentExamAttempt {
  id            String @id @default(cuid())
  examId        String
  studentId     String
  attemptNumber Int    @default(1)

  // Timing
  startedAt        DateTime  @default(now())
  submittedAt      DateTime?
  timeSpentSeconds Int? // Total time spent

  // Status
  isCompleted Boolean @default(false)
  isLate      Boolean @default(false)

  // Scoring (calculated after grading)
  totalScore Float?
  maxScore   Float?
  percentage Float?
  grade      Grade?
  isPassed   Boolean?

  // Grading status
  isGraded Boolean   @default(false)
  gradedAt DateTime?
  gradedBy String? // Teacher who graded

  // Technical metadata
  ipAddress  String?
  userAgent  String?
  deviceInfo String?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  exam         Exam            @relation(fields: [examId], references: [id], onDelete: Cascade)
  student      User            @relation("StudentExamAttempts", fields: [studentId], references: [id], onDelete: Cascade)
  gradedByUser User?           @relation("ExamAttemptsGraded", fields: [gradedBy], references: [id])
  answers      StudentAnswer[]

  @@unique([examId, studentId, attemptNumber])
  @@index([examId])
  @@index([studentId])
  @@index([isCompleted])
  @@map("student_exam_attempts")
}

model StudentAnswer {
  id         String @id @default(cuid())
  attemptId  String
  questionId String

  // Answer data based on question type
  selectedOptionId String? // For MCQ
  textAnswer       String?  @db.Text // For short/long answer
  uploadedFiles    String[] // Array of file URLs for file upload questions

  // Grading
  isCorrect    Boolean?
  marksAwarded Float?   @default(0)
  feedback     String?  @db.Text // Teacher feedback

  // Metadata
  answeredAt DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  attempt        StudentExamAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question       Question           @relation(fields: [questionId], references: [id])
  selectedOption QuestionOption?    @relation(fields: [selectedOptionId], references: [id])

  @@unique([attemptId, questionId])
  @@index([attemptId])
  @@index([questionId])
  @@map("student_answers")
}

// Legacy ExamSubmission model (kept for backward compatibility)
model ExamSubmission {
  id          String   @id @default(cuid())
  studentId   String
  examId      String
  submittedAt DateTime @default(now())
  answers     Json? // Store answers as JSON
  ipAddress   String?
  userAgent   String?
  isLate      Boolean  @default(false)
  createdAt   DateTime @default(now())

  // Relations
  student User @relation(fields: [studentId], references: [id], onDelete: Cascade)
  exam    Exam @relation(fields: [examId], references: [id], onDelete: Cascade)

  @@unique([studentId, examId])
  @@map("exam_submissions")
}

model Result {
  id          String    @id @default(cuid())
  studentId   String
  examId      String
  subjectId   String
  marks       Float
  totalMarks  Float
  percentage  Float
  grade       Grade?
  remarks     String?
  isPublished Boolean   @default(false)
  publishedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  student User    @relation(fields: [studentId], references: [id], onDelete: Cascade)
  exam    Exam    @relation(fields: [examId], references: [id], onDelete: Cascade)
  subject Subject @relation(fields: [subjectId], references: [id])

  @@unique([studentId, examId, subjectId])
  @@map("results")
}

model Certificate {
  id           String   @id @default(cuid())
  studentId    String
  examId       String?
  title        String
  description  String?
  pdfUrl       String
  templateId   String?
  serialNumber String   @unique
  issuedDate   DateTime @default(now())
  isValid      Boolean  @default(true)
  generatedAt  DateTime @default(now())
  createdAt    DateTime @default(now())

  // Relations
  student User  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  exam    Exam? @relation(fields: [examId], references: [id])

  @@map("certificates")
}

model Notification {
  id         String           @id @default(cuid())
  senderId   String? // null for system notifications
  receiverId String
  title      String
  message    String
  type       NotificationType @default(GENERAL)
  data       Json? // Additional notification data
  isRead     Boolean          @default(false)
  readAt     DateTime?
  sentAt     DateTime         @default(now())
  createdAt  DateTime         @default(now())

  // Relations
  sender   User? @relation("NotificationSender", fields: [senderId], references: [id])
  receiver User  @relation("NotificationReceiver", fields: [receiverId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model Message {
  id            String    @id @default(cuid())
  senderId      String
  receiverId    String? // null for class/group messages
  classId       String? // for class-wide messages
  content       String
  attachmentUrl String?
  isRead        Boolean   @default(false)
  readAt        DateTime?
  replyToId     String? // for threaded conversations
  isDeleted     Boolean   @default(false)
  timestamp     DateTime  @default(now())
  createdAt     DateTime  @default(now())

  // Relations
  sender   User      @relation("MessageSender", fields: [senderId], references: [id])
  receiver User?     @relation("MessageReceiver", fields: [receiverId], references: [id])
  class    Class?    @relation(fields: [classId], references: [id])
  replyTo  Message?  @relation("MessageReplies", fields: [replyToId], references: [id])
  replies  Message[] @relation("MessageReplies")

  @@map("messages")
}

model ActivityLog {
  id          String   @id @default(cuid())
  userId      String
  performedBy String? // Admin who performed the action
  action      String // e.g., "LOGIN", "USER_BLOCKED", "USER_UNBLOCKED", "USER_UPDATED", "USER_DELETED"
  entity      String? // e.g., "User", "LiveClass", "Material"
  entityId    String?
  details     Json?
  notes       String? // Admin notes for the action
  ipAddress   String?
  userAgent   String?
  timestamp   DateTime @default(now())

  @@map("activity_logs")
}

model SystemSettings {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  description String?
  isPublic    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("system_settings")
}

model FileUpload {
  id           String   @id @default(cuid())
  originalName String
  fileName     String   @unique
  mimeType     String
  size         Int
  path         String
  uploadedBy   String
  entityType   String? // e.g., "Material", "Notice", "Profile"
  entityId     String?
  isPublic     Boolean  @default(false)
  createdAt    DateTime @default(now())

  @@map("file_uploads")
}

// ============================================
// MODULE/SUBJECT LEARNING SYSTEM
// ============================================

model Module {
  id                       String       @id @default(cuid())
  title                    String
  slug                     String       @unique
  description              String?
  subjectId                String
  classId                  String?
  teacherId                String
  thumbnailUrl             String?
  featuredVideoUrl         String? // Featured video URL set by teacher (YouTube, etc.)
  featuredVideoTitle       String? // Title for the featured video
  featuredVideoDescription String? // Description for the featured video
  level                    String?      @default("BEGINNER") // BEGINNER, INTERMEDIATE, ADVANCED
  duration                 Int? // Total duration in minutes
  totalTopics              Int          @default(0)
  totalLessons             Int          @default(0)
  status                   ModuleStatus @default(DRAFT)
  isFeatured               Boolean      @default(false)
  isPublic                 Boolean      @default(false)
  viewCount                Int          @default(0)
  enrollmentCount          Int          @default(0)
  avgRating                Float?       @default(0)
  approvedBy               String? // Admin who approved the module
  approvedAt               DateTime? // When the module was approved
  rejectedBy               String? // Admin who rejected the module
  rejectedAt               DateTime? // When the module was rejected
  rejectionReason          String? // Reason for rejection
  createdAt                DateTime     @default(now())
  updatedAt                DateTime     @updatedAt
  publishedAt              DateTime?

  // Relations
  subject         Subject            @relation(fields: [subjectId], references: [id])
  class           Class?             @relation(fields: [classId], references: [id])
  teacher         User               @relation("ModuleTeacher", fields: [teacherId], references: [id])
  approver        User?              @relation("ModuleApprover", fields: [approvedBy], references: [id])
  rejecter        User?              @relation("ModuleRejecter", fields: [rejectedBy], references: [id])
  topics          Topic[]
  enrollments     ModuleEnrollment[]
  reviews         ModuleReview[]
  activityHistory ActivityHistory[]
  resources       ModuleResource[]
  liveClasses     LiveClass[] // Live classes associated with this module
  notices         Notice[] // Notices targeted to this module

  @@index([subjectId])
  @@index([teacherId])
  @@index([status])
  @@index([approvedBy])
  @@index([rejectedBy])
  @@map("modules")
}

model Topic {
  id           String   @id @default(cuid())
  title        String
  description  String?
  moduleId     String
  orderIndex   Int
  duration     Int? // Duration in minutes
  totalLessons Int      @default(0)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  module          Module            @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  lessons         Lesson[]
  progress        TopicProgress[]
  activityHistory ActivityHistory[]
  resources       ModuleResource[]

  @@index([moduleId])
  @@index([orderIndex])
  @@map("topics")
}

model Lesson {
  id             String     @id @default(cuid())
  title          String
  description    String?
  topicId        String
  type           LessonType @default(TEXT)
  orderIndex     Int
  duration       Int? // Duration in minutes
  videoUrl       String? // For VIDEO type
  youtubeVideoId String? // For regular YouTube videos
  content        String? // For TEXT type
  isFree         Boolean    @default(false)
  isPublished    Boolean    @default(true)
  viewCount      Int        @default(0)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  // Relations
  topic           Topic               @relation(fields: [topicId], references: [id], onDelete: Cascade)
  attachments     LessonAttachment[]
  liveSession     YoutubeLiveSession?
  progress        LessonProgress[]
  notes           LessonNote[]
  activityHistory ActivityHistory[]
  resources       ModuleResource[]

  @@index([topicId])
  @@index([type])
  @@index([orderIndex])
  @@map("lessons")
}

model LessonAttachment {
  id            String   @id @default(cuid())
  lessonId      String
  title         String
  fileName      String
  fileUrl       String
  fileSize      Int?
  fileType      String?
  downloadCount Int      @default(0)
  createdAt     DateTime @default(now())

  // Relations
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@index([lessonId])
  @@map("lesson_attachments")
}

model YoutubeLiveSession {
  id                 String    @id @default(cuid())
  lessonId           String    @unique
  youtubeUrl         String
  youtubeLiveId      String?
  scheduledStartTime DateTime
  scheduledEndTime   DateTime
  actualStartTime    DateTime?
  actualEndTime      DateTime?
  isLive             Boolean   @default(false)
  recordingUrl       String?
  maxViewers         Int?
  currentViewers     Int?      @default(0)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  // Relations
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@map("youtube_live_sessions")
}

model ModuleEnrollment {
  id             String    @id @default(cuid())
  moduleId       String
  studentId      String
  enrolledBy     String // Admin who enrolled the student
  enrolledAt     DateTime  @default(now())
  completedAt    DateTime?
  progress       Float     @default(0) // Percentage 0-100
  lastAccessedAt DateTime?
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  module         Module           @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  student        User             @relation("StudentEnrollments", fields: [studentId], references: [id], onDelete: Cascade)
  enrolledByUser User             @relation("EnrollmentCreator", fields: [enrolledBy], references: [id])
  topicProgress  TopicProgress[]
  lessonProgress LessonProgress[]

  @@unique([moduleId, studentId])
  @@index([studentId])
  @@index([enrolledBy])
  @@map("module_enrollments")
}

model TopicProgress {
  id               String    @id @default(cuid())
  enrollmentId     String
  topicId          String
  studentId        String
  completedLessons Int       @default(0)
  totalLessons     Int       @default(0)
  progress         Float     @default(0) // Percentage 0-100
  isCompleted      Boolean   @default(false)
  completedAt      DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  enrollment ModuleEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  topic      Topic            @relation(fields: [topicId], references: [id], onDelete: Cascade)
  student    User             @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([enrollmentId, topicId])
  @@index([studentId])
  @@map("topic_progress")
}

model LessonProgress {
  id            String    @id @default(cuid())
  lessonId      String
  studentId     String
  enrollmentId  String
  isCompleted   Boolean   @default(false)
  completedAt   DateTime?
  watchTime     Int?      @default(0) // in seconds
  lastPosition  Int?      @default(0) // in seconds for video
  attemptsCount Int?      @default(0) // for quizzes
  score         Float? // for quizzes/assignments
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  lesson     Lesson           @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  student    User             @relation(fields: [studentId], references: [id], onDelete: Cascade)
  enrollment ModuleEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)

  @@unique([lessonId, studentId])
  @@index([enrollmentId])
  @@map("lesson_progress")
}

model LessonNote {
  id        String   @id @default(cuid())
  lessonId  String
  studentId String
  content   String
  timestamp Int? // Video timestamp in seconds
  isPinned  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  lesson  Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  student User   @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([lessonId])
  @@index([studentId])
  @@map("lesson_notes")
}

model ModuleReview {
  id          String   @id @default(cuid())
  moduleId    String
  studentId   String
  rating      Int // 1-5
  comment     String?
  isPublished Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  module  Module @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  student User   @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([moduleId, studentId])
  @@map("module_reviews")
}

model ActivityHistory {
  id           String       @id @default(cuid())
  userId       String
  activityType ActivityType
  moduleId     String?
  topicId      String?
  lessonId     String?
  title        String
  description  String?
  metadata     Json? // Additional data
  ipAddress    String?
  userAgent    String?
  timestamp    DateTime     @default(now())

  // Relations
  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  module Module? @relation(fields: [moduleId], references: [id], onDelete: SetNull)
  topic  Topic?  @relation(fields: [topicId], references: [id], onDelete: SetNull)
  lesson Lesson? @relation(fields: [lessonId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([activityType])
  @@index([timestamp])
  @@index([moduleId])
  @@map("activity_history")
}

// ============================================
// MODULE CONTENT/RESOURCE SYSTEM
// ============================================

model ModuleResource {
  id String @id @default(cuid())

  // Content Details
  title       String
  description String?
  category    ResourceCategory @default(OTHER)
  tags        String[] // Searchable tags

  // File Information
  type        ResourceType
  fileUrl     String?
  fileName    String?
  fileSize    Int? // in bytes
  mimeType    String?
  externalUrl String? // For links, YouTube URLs

  // Attachment Points (Flexible - can attach to multiple levels)
  moduleId String?
  topicId  String?
  lessonId String?

  // Access Control
  status         ResourceStatus @default(PUBLISHED)
  isHidden       Boolean        @default(false)
  visibleToRoles String[] // ["STUDENT", "TEACHER", "ADMIN"]

  // Metadata
  orderIndex  Int     @default(0)
  version     Int     @default(1)
  isPinned    Boolean @default(false)
  isMandatory Boolean @default(false)

  // Analytics
  viewCount     Int @default(0)
  downloadCount Int @default(0)

  // Audit Trail
  uploadedBy  String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?
  archivedAt  DateTime?

  // Relations
  module     Module?             @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  topic      Topic?              @relation(fields: [topicId], references: [id], onDelete: Cascade)
  lesson     Lesson?             @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  uploader   User                @relation("ResourceUploader", fields: [uploadedBy], references: [id])
  accessLogs ResourceAccessLog[]

  @@index([moduleId])
  @@index([topicId])
  @@index([lessonId])
  @@index([status])
  @@index([category])
  @@index([uploadedBy])
  @@index([type])
  @@map("module_resources")
}

model ResourceAccessLog {
  id         String   @id @default(cuid())
  resourceId String
  userId     String
  action     String // VIEW, DOWNLOAD, EDIT, DELETE
  ipAddress  String?
  userAgent  String?
  metadata   Json?
  timestamp  DateTime @default(now())

  // Relations
  resource ModuleResource @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  user     User           @relation("ResourceAccess", fields: [userId], references: [id], onDelete: Cascade)

  @@index([resourceId])
  @@index([userId])
  @@index([timestamp])
  @@index([action])
  @@map("resource_access_logs")
}

// ============================================
// BATCH AND GRADUATION SYSTEM
// ============================================

model Batch {
  id              String      @id @default(cuid())
  name            String      @unique // e.g., "Batch 2025"
  description     String?
  startYear       Int // e.g., 2023
  endYear         Int // e.g., 2025
  startDate       DateTime
  endDate         DateTime?
  status          BatchStatus @default(PLANNING)
  maxStudents     Int?
  currentStudents Int         @default(0)

  // Metadata
  createdBy   String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime? // When marked as completed
  graduatedAt DateTime? // When graduation process completed

  // Relations
  createdByUser    User              @relation("BatchCreator", fields: [createdBy], references: [id])
  classBatches     ClassBatch[]
  students         User[]            @relation("StudentBatch")
  classEnrollments ClassEnrollment[]
  graduations      Graduation[]
  notices          Notice[] // Notices targeted to this batch

  // New unified enrollment system
  subjectEnrollments SubjectEnrollment[] @relation("BatchSubjectEnrollments")

  @@index([status])
  @@index([startYear, endYear])
  @@index([createdBy])
  @@map("batches")
}

model ClassBatch {
  id       String  @id @default(cuid())
  classId  String
  batchId  String
  sequence Int     @default(1) // Order in progression (1, 2, 3...)
  isActive Boolean @default(true)

  // Date ranges for this class within the batch
  startDate DateTime
  endDate   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  class Class @relation(fields: [classId], references: [id], onDelete: Cascade)
  batch Batch @relation(fields: [batchId], references: [id], onDelete: Cascade)

  @@unique([classId, batchId])
  @@index([batchId])
  @@index([classId])
  @@index([sequence])
  @@map("class_batches")
}

model ClassEnrollment {
  id          String    @id @default(cuid())
  studentId   String
  classId     String
  batchId     String
  enrolledAt  DateTime  @default(now())
  enrolledBy  String // Admin who enrolled
  completedAt DateTime?

  // Academic tracking
  isCompleted Boolean  @default(false)
  isPassed    Boolean?
  finalGrade  Grade?
  finalMarks  Float?
  totalMarks  Float?
  attendance  Float? // Percentage
  remarks     String?

  // Status
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  student        User  @relation("StudentClassEnrollments", fields: [studentId], references: [id], onDelete: Cascade)
  class          Class @relation(fields: [classId], references: [id])
  batch          Batch @relation(fields: [batchId], references: [id])
  enrolledByUser User  @relation("ClassEnrollmentCreator", fields: [enrolledBy], references: [id])

  @@unique([studentId, classId, batchId])
  @@index([batchId])
  @@index([studentId])
  @@index([classId])
  @@index([isActive])
  @@map("class_enrollments")
}

model Graduation {
  id             String   @id @default(cuid())
  batchId        String
  studentId      String
  graduatedAt    DateTime @default(now())
  graduationDate DateTime // Official ceremony date

  // Academic summary
  overallGrade      Grade?
  overallPercentage Float?
  totalCredits      Float?
  cgpa              Float?

  // Certificate
  certificateNo  String? @unique
  certificateUrl String?

  // Status
  isAwarded Boolean   @default(false)
  awardedAt DateTime?

  // Metadata
  remarks   String?
  honors    String? // "With Distinction", "With Honors", etc.
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  batch         Batch @relation(fields: [batchId], references: [id])
  student       User  @relation("StudentGraduations", fields: [studentId], references: [id])
  createdByUser User  @relation("GraduationCreator", fields: [createdBy], references: [id])

  @@unique([batchId, studentId])
  @@index([batchId])
  @@index([studentId])
  @@index([graduationDate])
  @@map("graduations")
}

// ============================================
// UNIFIED SUBJECT ENROLLMENT SYSTEM (OPTION 2 - HYBRID)
// ============================================

model SubjectEnrollment {
  id String @id @default(cuid())

  // Core relationships (following photo model)
  studentId String
  subjectId String
  classId   String
  batchId   String

  // Relations
  student User    @relation("StudentSubjectEnrollments", fields: [studentId], references: [id], onDelete: Cascade)
  subject Subject @relation("SubjectEnrollments", fields: [subjectId], references: [id], onDelete: Cascade)
  class   Class   @relation("ClassSubjectEnrollments", fields: [classId], references: [id], onDelete: Cascade)
  batch   Batch   @relation("BatchSubjectEnrollments", fields: [batchId], references: [id], onDelete: Cascade)

  // Enrollment metadata
  enrolledBy  String // Admin who enrolled the student
  enrolledAt  DateTime  @default(now())
  completedAt DateTime?

  // Academic tracking
  isActive    Boolean  @default(true)
  isCompleted Boolean  @default(false)
  isPassed    Boolean?

  // Performance metrics
  grade      Grade?
  finalMarks Float?
  totalMarks Float?
  percentage Float?
  attendance Float? // Percentage (0-100)

  // Progress tracking
  lastAccessed    DateTime?
  totalClasses    Int?      @default(0)
  attendedClasses Int?      @default(0)

  // Additional data
  remarks String?

  // Audit trail
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations to enrollment creator
  enrolledByUser User @relation("SubjectEnrollmentCreator", fields: [enrolledBy], references: [id])

  // Unique constraint: One enrollment per student-subject-class-batch combination
  @@unique([studentId, subjectId, classId, batchId])
  // Indexes for performance
  @@index([studentId])
  @@index([batchId])
  @@index([classId])
  @@index([subjectId])
  @@index([isActive])
  @@index([enrolledAt])
  @@index([completedAt])
  @@map("subject_enrollments")
}

// Audit Log Model for Security Tracking
model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  action     String
  resource   String?
  resourceId String?
  ipAddress  String
  userAgent  String?
  method     String
  path       String
  statusCode Int
  duration   Int // Request duration in milliseconds
  requestId  String?
  timestamp  DateTime @default(now())

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([timestamp])
  @@index([action])
  @@index([statusCode])
  @@index([requestId])
  @@map("audit_logs")
}

// Device Token Model for Firebase Cloud Messaging (FCM)
model DeviceToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique // FCM device token
  platform  String   @default("android") // android, ios, web
  deviceId  String? // Unique device identifier
  appVersion String? // App version for debugging
  isActive  Boolean  @default(true) // To disable tokens without deleting
  lastUsed  DateTime @default(now()) // Track when token was last verified
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation("UserDeviceTokens", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([isActive])
  @@index([platform])
  @@map("device_tokens")
}
